{"componentChunkName":"component---src-templates-blog-post-js","path":"/spring/resttemplate-thread-safe/","webpackCompilationHash":"7ba5c38d638cebfc2056","result":{"data":{"site":{"siteMetadata":{"title":"renuevo blog","author":"deokhwa kim","siteUrl":"https://renuevo.github.io","comment":{"disqusShortName":"https-renuevo-github-io","utterances":""},"sponsor":{"buyMeACoffeeId":""}}},"markdownRemark":{"id":"c09909de-153f-5527-a5ff-7e1b722fac3e","excerpt":"RestTemplate은 Spring에서 지원하는 http를 유용하게 쓸 수 있는 템플릿입니다 결론부터 말씀 드리자면 RestTemplate은 Thread Safe하게 설계 되어 만들어 졌습니다 Spring3 : RestTemplate 하지만 프로젝트에서 한번씩의 호출은 문제가 없었지만 연속적인 호출이 있을때 제대로 Connection을 맺지 못하고 Error가 나는 상황이 있었습니다 그래서 간단하게 해당 이슈에 관해 알아본 내용을 정리한 포스팅 입니다     RestTemplate은 Thread…","html":"<p><strong><em>RestTemplate은</em></strong> Spring에서 지원하는 http를 유용하게 쓸 수 있는 템플릿입니다<br>\n결론부터 말씀 드리자면 RestTemplate은 Thread Safe하게 설계 되어 만들어 졌습니다 <a href=\"https://spring.io/blog/2009/03/27/rest-in-spring-3-resttemplate\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Spring3 : RestTemplate</a><br>\n하지만 프로젝트에서 한번씩의 호출은 문제가 없었지만 연속적인 호출이 있을때 제대로 Connection을 맺지 못하고 <span class='red_font'>Error</span>가 나는 상황이 있었습니다<br>\n그래서 간단하게 해당 이슈에 관해 알아본 내용을 정리한 포스팅 입니다    </p>\n<h2 id=\"resttemplate은-thread-safe-하다\"><a href=\"#resttemplate%EC%9D%80-thread-safe-%ED%95%98%EB%8B%A4\" aria-label=\"resttemplate은 thread safe 하다 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RestTemplate은 Thread Safe 하다?</h2>\n<p><strong>맞습니다 RestTemplate은 Thread Safe 합니다</strong><br>\n그래서 흔히들 아래와 같이 <code class=\"language-text\">@Bean</code>으로 선언하여 사용해서 자원을 아끼는 구조로 설계합니다  </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RestConfig</span><span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token class-name\">RestTemplate</span> <span class=\"token function\">restTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 선언하게 되면 <code class=\"language-text\">@Autowired</code>를 통해 하나의 RestTemplate으로 http 통신을 처리 할 수 있습니다   </p>\n<br/>\n<h2 id=\"resttemplate의-http-프로토콜-요청\"><a href=\"#resttemplate%EC%9D%98-http-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C-%EC%9A%94%EC%B2%AD\" aria-label=\"resttemplate의 http 프로토콜 요청 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RestTemplate의 Http 프로토콜 요청</h2>\n<p>RestTemplate은 <a href=\"https://skasha.tistory.com/48\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">동작원리</a>를 살펴보면 기본적으로 Http 프로토콜의 요청을 보낼때 <code class=\"language-text\">SimpleClientHttpRequestFactory</code>을 활용하여 처리합니다</p>\n<p>이때 SimpleClientHttpRequestFactory에서 고려해야 할 점이 <code class=\"language-text\">2가지</code>가 있습니다</p>\n<blockquote>\n<h4 id=\"1-timeout\"><a href=\"#1-timeout\" aria-label=\"1 timeout permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Timeout</h4>\n<p>SimpleClientHttpRequestFactory의 기본 Timeout 시간은 다음과 같습니다 👉 <a href=\"https://howtodoinjava.com/spring-boot2/resttemplate/resttemplate-timeout-example/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Default Timeout</a> </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> connectionTimeout <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> readTimeout <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그래서 Timeout설정을 하지 않으면 <code class=\"language-text\">무한정</code>으로 connection을 물고 있는 상태가 발생하여 <span class='red_font'>시스템 오류</span>를 불러 일으킬 수 있습니다<br>\n이를 방지하기 위해서 일반적으로 아래와 같이 <code class=\"language-text\">Timeout</code>을 따로 지정합니다</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RestConfig</span><span class=\"token punctuation\">{</span>\n   <span class=\"token annotation punctuation\">@Bean</span>\n   <span class=\"token class-name\">RestTemplate</span> <span class=\"token function\">restTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n       <span class=\"token class-name\">SimpleClientHttpRequestFactory</span> factory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleClientHttpRequestFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       factory<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectTimeout</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//5초</span>\n       factory<span class=\"token punctuation\">.</span><span class=\"token function\">setReadTimeout</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">//5초</span>\n<span class=\"gatsby-highlight-code-line\">       <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestTemplate</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</blockquote>\n<br/>\n<blockquote>\n<h4 id=\"2-connection-방식\"><a href=\"#2-connection-%EB%B0%A9%EC%8B%9D\" aria-label=\"2 connection 방식 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Connection 방식</h4>\n<p>SimpleClientHttpRequestFactory의 Connection 방식은 매번 새로운 Connection을 만들어서 통신합니다<br>\n이 방식은 계속해서 통신을 해야하는 서비스 구조해서는 효율적이지 못한 방식입니다<br>\n그래서 <code class=\"language-text\">Connection pool</code>을 적용하기 위해서 <code class=\"language-text\">HttpComponentsClientHttpRequestFactor</code>을 <code class=\"language-text\">SimpleClientHttpRequestFactory</code>대신해서 사용합니다  </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RestConfig</span><span class=\"token punctuation\">{</span>\n   <span class=\"token annotation punctuation\">@Bean</span>\n   <span class=\"token class-name\">RestTemplate</span> <span class=\"token function\">restTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token class-name\">HttpComponentsClientHttpRequestFactory</span> factory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpComponentsClientHttpRequestFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      factory<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectTimeout</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//5초</span>\n      factory<span class=\"token punctuation\">.</span><span class=\"token function\">setReadTimeout</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">//5초</span>\n      <span class=\"token class-name\">HttpClient</span> httpClient <span class=\"token operator\">=</span> <span class=\"token class-name\">HttpClientBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">setMaxConnTotal</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">setMaxConnPerRoute</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      factory<span class=\"token punctuation\">.</span><span class=\"token function\">setHttpClient</span><span class=\"token punctuation\">(</span>httpClient<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RestTemplate</span><span class=\"token punctuation\">(</span>factory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 하면 Connection을 유지하면서 빠른 통신이 가능해 집니다</p>\n</blockquote>\n<br/>\n<h2 id=\"resttemplate-오류의-원인은-span-classred_fontkeep-alivespan\"><a href=\"#resttemplate-%EC%98%A4%EB%A5%98%EC%9D%98-%EC%9B%90%EC%9D%B8%EC%9D%80-span-classred_fontkeep-alivespan\" aria-label=\"resttemplate 오류의 원인은 span classred_fontkeep alivespan permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RestTemplate 오류의 원인은? <span class='red_font'>Keep-Alive</span></h2>\n<p>마침내 결론으로 어디서 문제가 발생하였는지 입니다<br>\n오류의 원인은 바로 <code class=\"language-text\">HttpComponentsClientHttpRequestFactory</code>을 도입하면 일어났습니다<br>\nConnection을 유지하면서 빠르게 처리하는 Http의 connection 방법을 <code class=\"language-text\">Keep-Alive</code>라고 합니다  </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 690px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.3170731707317%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe5NQKP/xAAYEAEAAwEAAAAAAAAAAAAAAAABABEhAv/aAAgBAQABBQK4OctmwMCj/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhABAQEAAAAAAAAAAAAAAAAAARAA/9oACAEBAAY/AsUn/8QAGBAAAwEBAAAAAAAAAAAAAAAAAAERMUH/2gAIAQEAAT8h10rTqGJbNcN7YJgf/9oADAMBAAIAAwAAABDDz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQEAAwEBAAAAAAAAAAAAAAERACFBYTH/2gAIAQEAAT8QdokEmsZhVFYdwwG757kuzadz5dARLho1Pc//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"keep-alive\"\n        title=\"keep-alive\"\n        src=\"/static/58143b62db6aff38af6510f532070bed/8c996/keep-alive.jpg\"\n        srcset=\"/static/58143b62db6aff38af6510f532070bed/6f483/keep-alive.jpg 173w,\n/static/58143b62db6aff38af6510f532070bed/0fa0d/keep-alive.jpg 345w,\n/static/58143b62db6aff38af6510f532070bed/8c996/keep-alive.jpg 690w,\n/static/58143b62db6aff38af6510f532070bed/1b844/keep-alive.jpg 820w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        loading=\"lazy\"\n      />\n    </span>\n<span class='img_caption'>source : <a href=\"https://www.imperva.com/learn/performance/http-keep-alive\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">imperva keep-alive</a></span></p>\n<p><strong>Keep-Alive는 통신을 받는 쪽에서 해당 Connection 유지를 위해서 지원여부를 확인해야 합니다</strong><br>\n하지만 지원하지 않는 솔루션 제품을 사용하고 있었고 <span class='red_font'>Connection 오류</span>가 발생하여 연속적인 호출에 있어서만 오류가 발생했던 것입니다<br>\n효율이 떨어지지만 SimpleClientHttpRequestFactory로 수정하였고 이후 문제없이 잘 작동되었습니다</p>\n<br/>\n<p>신규 개발 서비스에서는 <code class=\"language-text\">WebClient</code>를 도입하기를 권장드립니다 👉 <a href=\"https://junebuug.github.io/2019-02-11/resttemplate-vs-webclient\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RestTemplate 말고 WebClient</a><br>\n또는 Feign을 사용해 보세요 정말 좋습니다 <a href=\"https://woowabros.github.io/experience/2019/05/29/feign.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">우아한 feign 적용기</a>  </p>\n<hr>\n<h2 id=\"참고-사이트\"><a href=\"#%EC%B0%B8%EA%B3%A0-%EC%82%AC%EC%9D%B4%ED%8A%B8\" aria-label=\"참고 사이트 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고 사이트</h2>\n<p><a href=\"https://spring.io/blog/2009/03/27/rest-in-spring-3-resttemplate\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">REST in Spring 3: RestTemplate</a><br>\n<a href=\"https://www.imperva.com/learn/performance/http-keep-alive/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">imperva keep-alive</a><br>\n<a href=\"https://skasha.tistory.com/48\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">카샤의 만개시기 블로그</a><br>\n<a href=\"https://howtodoinjava.com/spring-boot2/resttemplate/resttemplate-timeout-example/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">HowToDoInJava</a>  </p>","frontmatter":{"title":"[Spring] RestTemplate는 Thread Safe할까?","date":"November 07, 2019"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/spring/resttemplate-thread-safe/","previous":{"fields":{"slug":"/design-pattern/publish-subscribe-pattern/"},"frontmatter":{"title":"[DesignPattern] 게시자/구독자 패턴(Publish Subscribe Pattern)이란?","category":"Design Pattern"}},"next":{"fields":{"slug":"/data-science/facebook-cambridge-analytica/"},"frontmatter":{"title":"[DataScience] 페이스북을 활용한 트럼프의 대선 전략과 LSA 알고리즘","category":"Data Science"}}}}}